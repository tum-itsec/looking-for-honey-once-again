from RDP_diff import compare_response_data, formats, formats_credssp, xrdp_err, vbox_err
import binascii

RESPONSES = {
    "XRDP": {
        0: [
            {"exception": -1, "data": "030000130ed000001234000201080000000000"},
            {"exception": -1, "data": "0300020902f0807f668201fd0a0100020100301a020116020103020100020101020100020101020300fff8020102048201d7000500147c00012a14760a01010001c0004d63446e81c0010c0c000400080000000000030c0800eb030000020cac01020000000300000020000000780100009327aa4cd88afdb91c8b1555d3c1400d208176b2849917f540835477393d7fdf01000000010000000100000006001c01525341310801000000080000ff000000010001004d6aad3e32d787945da05eab6bc2de2cfca52898ac3cd89b725cd64eab163539d134d746a878595444a642f25ff14498c73a139fb9997af112e77c4465a469cc886910c59767300dd46056876e0c8768aead58aaf0d1658ff8c252f5963285c9b8a338110f14961c336dd6a71cccda8f459c7ad6165bbb64f80b423c703f7f844cf7e814ee7a2c8ff1f7c339dda9102ff9d58cf50cb50559914e3e41c459958b5c9fce3a018d0845ec039a870f19610c72088e14eb44c3c7b0d8d1bb9dcb1d1de21f85ed917bacf31bb76d34bb35e23b2f7e89ca0fe3176b57c2647cd99705175e17fd68f0b5dfd76e0c892f4b7ad9aea5dd9526606e1e02316b122edc18bccc0000000000000000080048004f60174e1e500fe40f6f4432e3b6f797818012c9891225842ebf19ae0ba6de39a123b781dfd51344008cfa81a405b18574163c7c17c1289254fa73e30253c8510000000000000000"}
        ],
        1: [
            {"exception": -1, "data": "030000130ed000001234000201080001000000"},
            {"exception": -1, "data": "0300007102f0807f66670a0100020100301a020116020103020100020101020100020101020300fff80201020443000500147c00012a14760a01010001c0004d63446e802c010c0c000400080001000000030c1400eb030500ec03ed03ee03ef03f0030000020c0c000000000000000000"}
        ],
        2: [
            {"exception": -1, "data": "030000130ed000001234000201080001000000"},
            {"exception": -1, "data": "0300000902f0802180"}
        ],
        4: [
            {"exception": -1, "data": "030000130ed000001234000201080000000000"},
            {"exception": -1, "data": "0300000902f0802180"}
        ]
    },
    "xfreerdp": {
        0: [
            {"exception": -1, "data": "030000130ed000000000000203080000000000"},
            {"exception": -1, "data": "0300021302f0807f668202070a0100020100301a020122020103020100020101020100020101020300fff8020102048201e1000500147c00012a14760a01010001c0004d63446e81ca010c10000c0008000000000000000000030c0800eb030000020cac010200000002000000200000007801000058f448671468967ff58bf98e18ed7b59798b00dc8cd4dc64a94fefce2759e1e901000000010000000100000006001c01525341310801000000080000ff000000010001006b161ccf98aff48ca650f9c06b6afdb7703b8519f371660049f3a0360f4a238be4f559a03f71c199ba7a633057036eff0e3f85dafe104c38080bb9534982088c2a002aceaf3c3e4ba0053f80d22f1f1e08a780bb803187b7f0b7ff5a186074b66e21cda332e10a69c54cfa0161b710ca4b92515eba9742d401df69f6285fae0b48ff176436e5aeaa688ee0754f0fba114ab1f9c065b3f86f7adbf2b34b47f2df928f562cd4794f70eb283f306b543c9de0c24259604b1ffcb8954b69c6b18cd642f308e07399d26e1358296106940198881fbb8346372c44da9c0f6c57330e1e2bb7158f7455610a84fc8fd9cbaf8311337864205f36e93689742205b6c2c9da000000000000000008004800f0f88fa0fe905819b559653bc1c47a5f9e9f221b2e2c3eaf7cd5dad77ffc702c09acfeb4cf3603fbb0fec3e845544bf9cef76c357201fde7a3799dd86f6b0c420000000000000000040c0600ec03"}
        ],
        1: [
            {"exception": -1, "data": "030000130ed000000000000203080001000000"},
            {"exception": -1, "data": "0300007402f0807f666a0a0100020100301a020122020103020100020101020100020101020300fff80201020446000500147c00012a14760a01010001c0004d63446e30010c1000040008000100000000000000030c1400eb030500ec03ed03ee03ef03f0030000020c0c000000000000000000"}
        ],
        2: [
            {"exception": -1, "data": "030000130ed000000000000203080001000000"},
            {"exception": 1, "data": ""}
        ],
        4: [
            {"exception": 1, "data": ""}
        ]
    },
    "WINSRV2019": {
        0: [
            {"exception": -1, "data": "030000130ed000001234000300080005000000"},
            {"exception": 2, "data": ""}
        ],
        1: [
            {"exception": -1, "data": "030000130ed000001234000300080005000000"},
            {"exception": 1, "data": ""}
        ],
        2: [
            {"exception": -1, "data": "030000130ed00000123400021f080002000000"},
            {"exception": -1, "data": "30820102a003020106a181fa3081f73081f4a081f10481ee4e544c4d53535000020000001e001e003800000035828a624afe9169475d4548000000000000000098009800560000000a0063450000000f570049004e002d0055004e0042004c004a0049005400390031004400500002001e00570049004e002d0055004e0042004c004a0049005400390031004400500001001e00570049004e002d0055004e0042004c004a0049005400390031004400500004001e00570049004e002d0055004e0042004c004a0049005400390031004400500003001e00570049004e002d0055004e0042004c004a0049005400390031004400500007000800a4cc58b83723d70100000000"}
        ],
        4: [
            {"exception": 3, "data": ""}
        ],
    },
    "WINSRV2019noNLA": {
        0: [
            {"exception": -1, "data": "030000130ed000001234000300080001000000"},
            {"exception": 2, "data": ""}
        ],
        1: [
            {"exception": -1, "data": "030000130ed00000123400021f080001000000"},
            {"exception": -1, "data": "0300007402f0807f666a0a0100020100301a020122020103020100020101020100020101020300fff80201020446000500147c00012a14760a01010001c0004d63446e30010c10000b0008000100000004000000030c1400eb030500ec03ed03ee03ef03f0030000020c0c000000000000000000"}
        ],
        2: [
            {"exception": -1, "data": "030000130ed00000123400021f080002000000"},
            {"exception": -1, "data": "30820102a003020106a181fa3081f73081f4a081f10481ee4e544c4d53535000020000001e001e003800000035828a62f797fdd5c6b555e6000000000000000098009800560000000a0063450000000f570049004e002d0055004e0042004c004a0049005400390031004400500002001e00570049004e002d0055004e0042004c004a0049005400390031004400500001001e00570049004e002d0055004e0042004c004a0049005400390031004400500004001e00570049004e002d0055004e0042004c004a0049005400390031004400500003001e00570049004e002d0055004e0042004c004a0049005400390031004400500007000800275134143823d70100000000"}
        ],
        4: [
            {"exception": 3, "data": ""}
        ],
        "specifics": {
            "ServerData.Core.Version": ("range", 0x80005, 0x8000C + 1),
            "CredSSP.Version": ("range", 2, 4)
        }
    },
    "WINSRV2012R2": {
        0: [
            {"exception": -1, "data": "030000130ed000001234000300080005000000"},
            {"exception": 2, "data": ""}
        ],
        1: [
            {"exception": -1, "data": "030000130ed000001234000300080005000000"},
            {"exception": 1, "data": ""}
        ],
        2: [
            {"exception": -1, "data": "030000130ed00000123400020f080002000000"},
            {"exception": -1, "data": "30820102a003020103a181fa3081f73081f4a081f10481ee4e544c4d53535000020000001e001e003800000035828a62884563af261c28fa00000000000000009800980056000000060380250000000f570049004e002d0037004d004400480047004d0037004f004b004900340002001e00570049004e002d0037004d004400480047004d0037004f004b004900340001001e00570049004e002d0037004d004400480047004d0037004f004b004900340004001e00570049004e002d0037004d004400480047004d0037004f004b004900340003001e00570049004e002d0037004d004400480047004d0037004f004b004900340007000800835b2c717c23d70100000000"}
        ],
        4: [
            {"exception": 3, "data": ""}
        ],
        "specifics": {
            "NegoResp.Flags": ("&", 0x10, 0),
        }
    },
    "WINSRV2012R2noNLA": {
        0: [
            {"exception": -1, "data": "030000130ed00000123400020f080000000000"},
            {"exception": -1, "data": "0300021b02f0807f6682020f0a0100020100301a020122020103020100020101020100020101020300fff8020102048201e9000500147c00012a14760a01010001c0004d63446e81d2010c1000040008000000000001000000030c0800eb030000020cac0102000000020000002000000078010000899227f0212f4790b44062b6dd2a1de89e228059e9e0a03ebbcf28f9eaf8179101000000010000000100000006001c01525341310801000000080000ff00000001000100a70c01ed3ff42733d375d6f6b4643ff9e1b410129103f5a5ace2919ec9912e447497d3fbe76a4f48fa2e15ec831d6e87d02ee6bb6815b4846338c067a5a03e51bdd81e032f09cde518ebcbe722713b9da4d622330102ed3c0aef90922e68201fc271fca56eebc49f33212b336957af6996ba117d4d6832223205ea00587389e10347e22cd660deafb71febdf10897fb08da4432fa2024d6379f39ddc3af03f252450e8ab9726f6b9988f9ab4e876063ed1954bf4de13d7a721e60fc4d7c3bb7110f6fbd158c327b7d164900812659ac402464f97946ce0ea604ca26e9c50566211304ae50ee0113a9c243be13de512247d75c1b6a79cc3d2a0c48bd947c418d3000000000000000008004800d464125154e95bac26e57b55ab8db15a0051dd0034cafd63d55fb294649bafd054b1fc1bcce74a4893752e70d404c2c112d4d6b9c0ea3acca94a7d90f541ec280000000000000000040c06000000080c080000000000"}
        ],
        1: [
            {"exception": -1, "data": "030000130ed00000123400020f080001000000"},
            {"exception": -1, "data": "0300007402f0807f666a0a0100020100301a020122020103020100020101020100020101020300fff80201020446000500147c00012a14760a01010001c0004d63446e30010c1000040008000100000001000000030c1400eb030500ec03ed03ee03ef03f0030000020c0c000000000000000000"}
        ],
        2: [
            {"exception": -1, "data": "030000130ed00000123400020f080002000000"},
            {"exception": -1, "data": "30820102a003020103a181fa3081f73081f4a081f10481ee4e544c4d53535000020000001e001e003800000035828a625c1e817b3eca43ad00000000000000009800980056000000060380250000000f570049004e002d0037004d004400480047004d0037004f004b004900340002001e00570049004e002d0037004d004400480047004d0037004f004b004900340001001e00570049004e002d0037004d004400480047004d0037004f004b004900340004001e00570049004e002d0037004d004400480047004d0037004f004b004900340003001e00570049004e002d0037004d004400480047004d0037004f004b004900340007000800989f9baa7c23d70100000000"}
        ],
        4: [
            {"exception": 3, "data": ""}
        ],
        "specifics": {
            "NegoResp.Flags": ("&", 0x10, 0),
            "CredSSP.Version": ("range", 0, 3)
        }
    },
    "WINSRV2008R2noNLA": {
        0: [
            {"exception": -1, "data": "030000130ed000001234000201080000000000"},
            {"exception": -1, "data": "0300020902f0807f668201fd0a0100020100301a020122020103020100020101020100020101020300fff8020102048201d7000500147c00012a14760a01010001c0004d63446e81c0010c0c000400080000000000030c0800eb030000020cac01020000000200000020000000780100004c9375e2c3738010f3c0624dc2538187af22f52773fb9577874a34ae4b33e3e901000000010000000100000006001c01525341310801000000080000ff00000001000100fd6ea3b424019e4bcf8b9e3d3744536258f5b888189adee9c490009ab7cb573a5c2f58a232ea919a9268af79689c34bf98b5ce1053c8d1c9f42e14423e6f13109a98368b13a978afa2ae887bcc15a96cde31fb5e842e32afe9061f0fbbb9ad0fcf3834617403fdf3a77023fe8eb83f11fc70a2e8b1060668974ef59b8afae322895dff2ea1f36bde3a8ce65d14051b98b2c72e5be9cf57e44c9825ba94ae3727aa002b66e3428af0d8446d2fe547f6ef4744bfab5e3bc8094d98eaef37806fec566d1e3e39fc9f392cda8f8d05ec46a90bf100f82c2b0448600cf371258880a79e559abb74e395590c1074c88ed570d1ddb1226ada0adcef4376e27cac75e0ad000000000000000008004800bb8a28be7005e91379032530322a15d9b82d51dcc4ae7f351eaae8c8d66aeb53672834df3d6a18ad636217400962500895d53e923f49020acee37bc8a2436a0f0000000000000000"}
        ],
        1: [
            {"exception": -1, "data": "030000130ed000001234000201080001000000"},
            {"exception": -1, "data": "0300007002f0807f66660a0100020100301a020122020103020100020101020100020101020300fff80201020442000500147c00012a14760a01010001c0004d63446e2c010c0c000400080001000000030c1400eb030500ec03ed03ee03ef03f0030000020c0c000000000000000000"}
        ],
        2: [
            {"exception": -1, "data": "030000130ed000001234000201080002000000"},
            {"exception": 5, "data": ""}
        ],
        4: [
            {"exception": 3, "data": ""}
        ],
        "specifics": {
            "NegoResp.Flags": ("&", 0x10, 0),
            "CredSSP.Version": ("range", 0, 3)
        }
    },
    "WINSRV2008R2": {
        0: [
            {"exception": -1, "data": "030000130ed000001234000300080005000000"},
            {"exception": 3, "data": ""}
        ],
        1: [
            {"exception": -1, "data": "030000130ed000001234000300080005000000"},
            {"exception": 3, "data": ""}
        ],
        2: [
            {"exception": -1, "data": "030000130ed000001234000201080002000000"},
            {"exception": 5, "data": ""}
        ],
        4: [
            {"exception": 3, "data": ""}
        ],
        "specifics": {
            "NegoResp.Flags": ("&", 0x10, 0),
            "CredSSP.Version": ("range", 0, 3)
        }
    },
    "WINSRV2003": {
        0: [
            {"exception": -1, "data": "030000130ed000001234000200080000000000"},
            {"exception": 1, "data": ""}
        ],
        1: [
            {"exception": -1, "data": "030000130ed000001234000300080002000000"},
            {"exception": 1, "data": ""}
        ],
        2: [
            {"exception": -1, "data": "030000130ed000001234000300080002000000"},
            {"exception": 1, "data": ""}
        ],
        4: [
            {"exception": 2, "data": ""}
        ],
        "specifics": {
            "NegoResp.Flags": ("&", 0x10, 0),
            "CredSSP.Version": ("range", 0, 3)
        }
    },
    "heralding": {
        0: [
            {"exception": -1, "data": "030000130ed000001234000300080001000000"},
            {"exception": 1, "data": ""}
        ],
        1: [
            {"exception": -1, "data": "030000130ed000001234000200080001000000"},
            {"exception": -1, "data": "0300014902f0807f6682013d0a0100020100301a020122020103020100020101020100020101020300fff802010204820117000500147c00012a14760a01010001c0004d63446e8100010c0c000400080001000000030c0800eb030000020cec00000000000000000020000000b8000000f9dfc4708a08cd7335513aa3215f8fa1ee51d64e6a955a793012bff526fb212801000000010000000100000006005c005253413148000000000200003f0000000100010084d27eefbcbf9612a5e6d65ba6c3c2f1364aa049740437ca7cd94895db49737d74e255b443dfa2b121596738b4b826b1698e121410fe2b1b92f11b3c4a093f97000000000000000008004800512f06dba3215cd7dc2f9f34991aea970e520d2d39fe3d00e5d44bf93905c106db6d0455d0809a4abae08e58cb2529bd9159f053553f3a1c513f9dd89695fc030000000000000000"}
        ],
        2: [
            {"exception": -1, "data": "030000130ed000001234000200080001000000"},
            {"exception": 2, "data": ""}
        ],
        4: [
            {"exception": -1, "data": "030000130ed000001234000200080001000000"},
            {"exception": 1, "data": ""}
        ],
        "specifics": {
            "NegoResp.Flags": ("=", None, 8)
        }
    },
    "rdpynoTLS": {
        0: [
            {"exception": -1, "data": "030000130ed000000000000200080000000000"},
            {"exception": -1, "data": "0300014d02f0807f668201410a010002010030190201160201030201000201010201000201010202fff80201020482011c000500147c0001811214760a01010001c0004d63446e8104010c1000040008000000000000000000020cec00020000000300000020000000b8000000d95272a5e5e647f968038a5b9fa6b6bcf3277eecf3d7c2cd79b0ae6851193d2401000000010000000100000006005c005253413148000000000200003f0000000100010067d0b0eaedb50c21f232e5eca66f65687d082c0ec55929742683b77293a2aa0d6cf345efd3151b9698c935554d9a278afd444c6aaf76ab3e4fba784b72c693bd000000000000000008004800969ca14f1ba37f78e7bfd771c9ff21bef4023cb505cf94dc8224b76d253f845f6a597e54b1e1bc32aab5b325a311f2aafa94299f84fc1a408fa7b8615076372b0000000000000000030c0800eb030000"}
        ],
        1: [
            {"exception": -1, "data": "030000130ed000000000000200080000000000"},
            {"exception": 1, "data": ""}
        ],
        2: [
            {"exception": -1, "data": "030000130ed000000000000200080000000000"},
            {"exception": 1, "data": ""}
        ],
        4: [
            {"exception": 2, "data": ""}
        ]
    },
    "rdpy": {
        0: [
            {"exception": -1, "data": "030000130ed000000000000200080000000000"},
            {"exception": -1, "data": "0300014d02f0807f668201410a010002010030190201160201030201000201010201000201010202fff80201020482011c000500147c0001811214760a01010001c0004d63446e8104010c1000040008000000000000000000020cec00020000000300000020000000b8000000d7f1dea3d241d74bf0a2c872d86c97b4fae1585d01a0e2f3fbc3cf317f46aae801000000010000000100000006005c005253413148000000000200003f00000001000100cde6be130dac6e3327c8a17b0b7d6edeb408e3511cb0c7285d8442c05777e168e7be81f30919445156814c4f7d00a765d006ad92f884dc1aca590d5d5831b2a40000000000000000080048000e94ddfcd2077c7c2d6fec035ea6fbc21032b138ec50a18ec4852747f26efeed06c87b2e5248ffa508dcd222f6faefbf98e114dbb149edc32e4e0a95209155240000000000000000030c0800eb030000"}
        ],
        1: [
            {"exception": -1, "data": "030000130ed000000000000200080001000000"},
            {"exception": -1, "data": "0300007302f0807f66690a010002010030190201160201030201000201010201000201010202fff80201020446000500147c00013e14760a01010001c0004d63446e30010c1000040008000100000000000000020c0c000000000000000000030c1400eb030500ec03ed03ee03ef03f0030000"}
        ],
        2: [
            {"exception": -1, "data": "030000130ed000000000000200080001000000"},
            {"exception": 1, "data": ""}
        ],
        4: [
            {"exception": 1, "data": ""}
        ]
    },
    "VirtualBoxnoTLS": {
        0: [
            {"exception": -1, "data": "030000130ed000003412000201080000000000"},
            {"exception": -1, "data": "0300014b02f0807f6682013f0a0100020100301a020122020103020100020101020100020101020300fff802010204820119000500147c00012a14760a01010001c0004d63446e8102010c0c000400080000000000030c0a00eb0300000000020cec00020000000200000020000000b80000005627408cda838be2791972924b9cf7dccdea4e45efa0b1a1414917062d998abb01000000010000000100000006005c005253413148000000000200003f00000001000100c9798696cc7ff4af501590bb6ef456296b31252d8138197ac7cc240e59e14ce39e7966071151057609f5e36a7dfaac2d92f72a9ffeb995aba4647b66912732bf000000000000000008004800ef99a9fcb447928238f71ab614d51ff6eb0b9068739998036f94f049de8a0458d6ea9ed6c2fb0d1f7ff82c751ce2245fcfa85aa6d1e216fe60a12af25a828d4d0000000000000000"}
        ],
        1: [
            {"exception": -1, "data": "030000130ed000003412000300080003000000"},
            {"exception": 1, "data": ""}
        ],
        2: [
            {"exception": -1, "data": "030000130ed000003412000300080003000000"},
            {"exception": 1, "data": ""}
        ],
        4: [
            {"exception": -1, "data": "0300000b06d00000341200"}
        ]
    },
}

def unp(el, i):
    if not el["data"]:
        return ""
    elif el["data"].startswith("03000009"):
        return xrdp_err.unpack(binascii.unhexlify(el["data"]))[0]
    elif el["data"].startswith("0300000b"):
        return vbox_err.unpack(binascii.unhexlify(el["data"]))[0]
    elif not el["data"].startswith("03"):
        return formats_credssp[i].unpack(binascii.unhexlify(el["data"]))[0]
    else:
        return formats[i].unpack(binascii.unhexlify(el["data"]))[0]

RESPONSES_UNPACK = dict()
for key in RESPONSES:
    RESPONSES_UNPACK[key] = dict()
    for resps_outer in RESPONSES[key].keys():
        if not isinstance(resps_outer, int):
            continue
        RESPONSES_UNPACK[key][resps_outer] = [{
            "exception": el["exception"],
            "data": unp(el, i)
        } for i, el in enumerate(RESPONSES[key][resps_outer])]

def classify_response(resp_data, conn_type):
    simils = dict()

    for resp in RESPONSES:
        try:
            simil, diff_fields_new = compare_response_data(
                resp_data, 
                RESPONSES_UNPACK[resp][conn_type],
                RESPONSES_UNPACK[resp]["specifics"] if "specifics" in RESPONSES_UNPACK[resp] else None)
        except KeyError:
            continue
            
        simils[resp] = (simil, diff_fields_new)
    return simils